<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="java,">










<meta name="description" content="指令重排1. 定义 计算机执行指令的顺序是在程序编译器编译之后形成的指令序列 一般而言，指令序列会输出确定的结果以保证每次的执行都有确定的结果（串行情况下） 一般情况下，CPU和编译器为了提升程序执行的效率，会按照一定的规则允许指令重排。这种优化会带来一些执行上的逻辑问题（代码逻辑间存在一定的先后顺序），并发情况下会发生二义性，即不同的执行逻辑得到不同的结果信息  2. 数据依赖性（仅单线程下有效">
<meta name="keywords" content="java">
<meta property="og:type" content="article">
<meta property="og:title" content="java实战高并发笔记">
<meta property="og:url" content="http://yoursite.com/2019/10/14/java实战高并发笔记/index.html">
<meta property="og:site_name" content="freshham">
<meta property="og:description" content="指令重排1. 定义 计算机执行指令的顺序是在程序编译器编译之后形成的指令序列 一般而言，指令序列会输出确定的结果以保证每次的执行都有确定的结果（串行情况下） 一般情况下，CPU和编译器为了提升程序执行的效率，会按照一定的规则允许指令重排。这种优化会带来一些执行上的逻辑问题（代码逻辑间存在一定的先后顺序），并发情况下会发生二义性，即不同的执行逻辑得到不同的结果信息  2. 数据依赖性（仅单线程下有效">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-11-04T08:23:23.534Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="java实战高并发笔记">
<meta name="twitter:description" content="指令重排1. 定义 计算机执行指令的顺序是在程序编译器编译之后形成的指令序列 一般而言，指令序列会输出确定的结果以保证每次的执行都有确定的结果（串行情况下） 一般情况下，CPU和编译器为了提升程序执行的效率，会按照一定的规则允许指令重排。这种优化会带来一些执行上的逻辑问题（代码逻辑间存在一定的先后顺序），并发情况下会发生二义性，即不同的执行逻辑得到不同的结果信息  2. 数据依赖性（仅单线程下有效">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/10/14/java实战高并发笔记/">





  <title>java实战高并发笔记 | freshham</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">freshham</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">hello guys</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/14/java实战高并发笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="freshham">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="freshham">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">java实战高并发笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-14T17:36:04+08:00">
                2019-10-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="指令重排"><a href="#指令重排" class="headerlink" title="指令重排"></a>指令重排</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h2><blockquote>
<p>计算机执行指令的顺序是在程序编译器编译之后形成的指令序列</p>
<p>一般而言，指令序列会输出确定的结果以保证每次的执行都有确定的结果（串行情况下）</p>
<p>一般情况下，CPU和编译器为了提升程序执行的效率，会按照一定的规则允许指令重排。这种优化会带来一些执行上的逻辑问题（代码逻辑间存在一定的先后顺序），并发情况下会发生二义性，即不同的执行逻辑得到不同的结果信息</p>
</blockquote>
<h2 id="2-数据依赖性（仅单线程下有效）"><a href="#2-数据依赖性（仅单线程下有效）" class="headerlink" title="2. 数据依赖性（仅单线程下有效）"></a>2. 数据依赖性（仅单线程下有效）</h2><blockquote>
<p>不同的程序指令间存在固定先后顺序且不可重排，不允许交互</p>
</blockquote>
<ul>
<li>例：<ul>
<li>a = 1;b = a;  写变量，读此变量</li>
<li>a = 1;a = 2;  写变量，重写此变量</li>
<li>a = b;b = 1;  读变量，写此变量</li>
</ul>
</li>
<li>分析：写操作位置不允许变化</li>
</ul>
<h2 id="3-as-if-serial语义"><a href="#3-as-if-serial语义" class="headerlink" title="3. as-if-serial语义"></a>3. as-if-serial语义</h2><blockquote>
<p>不管怎么重排序，<strong>单线程</strong>程序的执行结果不能被改变。</p>
</blockquote>
<ul>
<li><p>分析：单线程情况下必须遵守，其余情况下可不遵守</p>
</li>
<li><p>例：</p>
<ul>
<li>Double pi = 3.14;</li>
<li>double r = 1.0;</li>
<li>double area = pi * r * r;</li>
</ul>
<p>分析：A -&gt; C,B -&gt; C,单线程情况下，A，B可重排，C必须在A，B之后</p>
</li>
</ul>
<h2 id="4-Happen-Before规则"><a href="#4-Happen-Before规则" class="headerlink" title="4. Happen-Before规则"></a>4. Happen-Before规则</h2><ul>
<li>程序顺序原则：一个线程内保证语义的串行性</li>
<li>volatile规则：volatile变量的写，先发生于读，这保证了volatile变量的可见性</li>
<li>锁规则：解锁（unlock）必然发生在随后的加锁（lock）前</li>
<li>传递性：A先于B，B先于C，那么A必然先于C</li>
<li>线程的start()方法先于它的每个动作</li>
<li>线程的所有操作先于线程的终结（Thread.join()）</li>
<li>线程的中断（interrupt）先于被中断线程的代码</li>
<li>对象的构造函数执行，结束先于finalize()方法</li>
</ul>
<h1 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a>进程与线程</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><ul>
<li><p>书面版</p>
<blockquote>
<p>进程是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。在早期面向进程设计的计算机结构中，进程是程序的基本执行实体。在当代面向线程设计的计算机结构中，进程是线程的容器。程序是指令、数据及其组织形式的描述，进程是程序的实体。</p>
</blockquote>
</li>
<li><p>通俗版</p>
<blockquote>
<p>程序：后缀为.exe的文件可以被理解为一个程序</p>
<p>进程：.exe文件启动后就是一个进程</p>
</blockquote>
</li>
<li><p>进程是线程的容器，进程内可容纳若干个线程</p>
</li>
<li><p>线程事轻量级的进程，是程序执行的最小单位</p>
</li>
<li><p>使用多线程而不是多进程进行并发程序的设计是因为线程间的切换和调度的成本远低于进程</p>
</li>
</ul>
<h2 id="线程的状态"><a href="#线程的状态" class="headerlink" title="线程的状态"></a>线程的状态</h2><ul>
<li>Thread类中的State枚举：<ul>
<li>NEW：刚创建，未开始执行，start（）方法调用后开始执行</li>
<li>RUNNABLE：执行时，所有资源已经准备好</li>
<li>BLOCKED：锁，阻塞</li>
<li>WAITING：无时间限制等待</li>
<li>TIMED_WAITING：有时限的等待</li>
<li>TERMINATED：结束</li>
</ul>
</li>
</ul>
<h2 id="线程的基本操作"><a href="#线程的基本操作" class="headerlink" title="线程的基本操作"></a>线程的基本操作</h2><ul>
<li><p>新建线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Thread t1 = <span class="keyword">new</span> Thread();</span><br><span class="line">t1.start();</span><br><span class="line"><span class="comment">// 可通过继承Thread类或实现Runnable接口，实现run方法（线程具体执行方法）</span></span><br><span class="line"><span class="comment">// 构造方法Thread（Runnable target）：传入Runnable实例，start方法调用run方法会调用target.run</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 例</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateThread3</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> CreateThread3());</span><br><span class="line">    t1.start();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sout(<span class="string">"hello, i'm runnable"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>终止线程</p>
<blockquote>
<p>一般来说，线程在执行完毕后就会结束，自动关闭，无需手工关闭</p>
<p>例外：执行体本身为超大无穷循环，需要手动关闭</p>
</blockquote>
<ul>
<li><p>关闭方法：</p>
<ul>
<li><p>stop（）：强制关闭，可能造成数据不一致问题（写线程未完全执行）</p>
</li>
<li><p>在线程类中自定义stopMe标志和stopMe（）方法</p>
<ul>
<li><p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ChangeObjectThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">  <span class="keyword">volatile</span> <span class="keyword">boolean</span> stopme = <span class="keyword">false</span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopMe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    stopme = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (stopme) &#123;</span><br><span class="line">        sout(<span class="string">"stopped"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">synchronized</span> (u) &#123;</span><br><span class="line">        sout(<span class="string">"任务执行中"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      Thread.yield();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>线程中断</p>
<blockquote>
<p>重要的线程协作机制</p>
<p>通知目标线程退出，线程中自行判断退出时机</p>
</blockquote>
<ul>
<li><p>相关方法：</p>
<ul>
<li><p>Thread.interrupt()：</p>
<blockquote>
<p>实例方法，通知目标线程中断（设置中断标识位）。</p>
</blockquote>
</li>
<li><p>Thread.isInterrupted()</p>
<blockquote>
<p>实例方法，判断当前线程是否被中断</p>
<p>定义在Thread类的run方法体中，判断中断位</p>
</blockquote>
</li>
<li><p>Thread.interrupted()</p>
<blockquote>
<p>静态方法，判断当前线程是否被中断，同时，清除当前线程的中断标志位</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="等待（wait）和通知（notify）"><a href="#等待（wait）和通知（notify）" class="headerlink" title="等待（wait）和通知（notify）"></a>等待（wait）和通知（notify）</h1><blockquote>
<p>线程对象调用wait方法后会进入特定Object对象（通过synchronized加锁）的等待队列</p>
<p>当其他线程调用此Object对象的notify方法时，会从此对象的等待队列中随机唤醒一个线程</p>
<p>或，当其他线程调用此Object对象的notifyAll方法时，会唤醒此对象等待队列中的所有线程</p>
<p>wait，notify，notifyAll方法的调用必须在通过synchronized方法加锁的同步方法或同步代码块中</p>
</blockquote>
<ul>
<li><p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleWN</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">static</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        sout(<span class="string">"T1 start"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        sout(<span class="string">"T1 wait for obj"</span>);</span><br><span class="line">        obj.wait();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      sout(<span class="string">"T1 end"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        sout(<span class="string">"T2 start! notify one thread"</span>);</span><br><span class="line">        obj.notify();</span><br><span class="line">        sout(<span class="string">"T2 end"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        	e.printStackTrace();</span><br><span class="line">      	&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> T1();</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> T2();</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="挂起（suspend）和继续执行（resume）线程"><a href="#挂起（suspend）和继续执行（resume）线程" class="headerlink" title="挂起（suspend）和继续执行（resume）线程"></a>挂起（suspend）和继续执行（resume）线程</h1><ul>
<li>不推荐使用</li>
<li>suspend挂起时，不会释放对应的锁资源</li>
<li>如果resume方法先于suspend方法调用，可能导致线程无限挂起，相关锁资源无限阻塞</li>
</ul>
<h1 id="等待线程结束（join）与谦让（yield）"><a href="#等待线程结束（join）与谦让（yield）" class="headerlink" title="等待线程结束（join）与谦让（yield）"></a>等待线程结束（join）与谦让（yield）</h1><ul>
<li><p>join：</p>
<blockquote>
<p>一个线程的输入可能依赖于另一个或多个线程的输出，此时，此线程就需要等待依赖线程执行完毕才能继续执行</p>
<p>join（）：无限制阻塞当前线程到目标线程执行完毕</p>
<p>join（long millis）：等待目标线程指定时间，如果超时，则当前线程停止等待，开始执行</p>
</blockquote>
<ul>
<li><p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinMain</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100000</span>; i++);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    AddThread at = <span class="keyword">new</span> AddThread();</span><br><span class="line">    at.start();</span><br><span class="line">    at.join();</span><br><span class="line">    sout(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>join方法本质：</p>
<blockquote>
<p>join方法的本质是让调用线程在目标线程上执行wait()方法进行等待。</p>
<p>被等待的目标线程在执行完毕推出时，会调用notifyAll方法，唤起所有的等待线程</p>
</blockquote>
</li>
<li><p>方法源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">(<span class="keyword">long</span> millis)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> base = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">long</span> now = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (millis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"timeout value is negative"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (millis == <span class="number">0</span>) &#123;  <span class="comment">//由于上一步传入参数为0，因此调用当前判断</span></span><br><span class="line">            <span class="keyword">while</span> (isAlive()) &#123; <span class="comment">//判断子线程是否存活</span></span><br><span class="line">                wait(<span class="number">0</span>); <span class="comment">//调用wait(0)方法</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">                <span class="keyword">long</span> delay = millis - now;</span><br><span class="line">                <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                wait(delay);</span><br><span class="line">                now = System.currentTimeMillis() - base;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>yield方法</p>
<blockquote>
<p>静态方法，执行时使当前线程让出CPU资源，但当前线程仍会参与CPU资源的争夺，即，当前线程在完成一定工作后，释放CPU资源并和其他线程重新进行CPU资源的分配</p>
</blockquote>
<ul>
<li><p>使用场景：</p>
<blockquote>
<p>当一个线程的优先级低，较不重要时，可以通过在适当时间调用yield方法释放其所占用的CPU资源，从而给其它重要线程更多的工作机会</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h1 id="volatile与java内存模型（JMM）"><a href="#volatile与java内存模型（JMM）" class="headerlink" title="volatile与java内存模型（JMM）"></a>volatile与java内存模型（JMM）</h1><ul>
<li><p>volatile关键字：</p>
<blockquote>
<p>volatile声明的变量会通知虚拟机此变量极可能被程序或线程修改，从而虚拟机为保证此变量在修改后应用程序范围内的所有线程都能看到此改动，会采用特殊手段保证变量的可见性</p>
<p>volatile无法代替锁，只能保证数据的可见性和有序性，无法保证复合操作的原子性</p>
</blockquote>
</li>
<li><p>使用条件：</p>
<blockquote>
<ol>
<li>对变量的写操作不依赖于当前值（即不依赖于对变量的读操作，自增，自减等都不行）</li>
<li>该变量没有包含在具有其他变量的不变式中</li>
</ol>
</blockquote>
</li>
<li><p>使用场景示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 状态标记校验</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">boolean</span> inited = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">// 线程1</span></span><br><span class="line">context = loadContext();</span><br><span class="line">inited = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程2</span></span><br><span class="line"><span class="keyword">while</span>(!inited) &#123;</span><br><span class="line">  sleep();</span><br><span class="line">&#125;</span><br><span class="line">doSomethingWithConfig(context);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// java double check（双重检查——单例模式）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">null</span>;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">          instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="线程组：分门别类的管理"><a href="#线程组：分门别类的管理" class="headerlink" title="线程组：分门别类的管理"></a>线程组：分门别类的管理</h1><ul>
<li><p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadGroupName</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建线程组</span></span><br><span class="line">    ThreadGroup tg = <span class="keyword">new</span> ThreadGroup(<span class="string">"PrintGroup"</span>);</span><br><span class="line">    <span class="comment">// 将t1，t2两线程加入线程组</span></span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(tg, <span class="keyword">new</span> ThreadGroupName(), <span class="string">"T1"</span>);</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(tg, <span class="keyword">new</span> ThreadGroupName(), <span class="string">"T2"</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 线程组重要功能</span></span><br><span class="line"><span class="comment">    * 展示活动线程总数</span></span><br><span class="line"><span class="comment">    * 打印所有线程信息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    sout(tg.activeCount());</span><br><span class="line">    tg.list();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String groupAndName = Thread.currentThread().getThreadGroup().getName() + <span class="string">"-"</span> + Thread.currentThread().getName();</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">      sout(<span class="string">"I am "</span> + groupAndName);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="守护线程（Daemon）"><a href="#守护线程（Daemon）" class="headerlink" title="守护线程（Daemon）"></a>守护线程（Daemon）</h1><blockquote>
<p>特殊类型线程，在后台完成一些系统性的服务（垃圾回收，JIT线程）</p>
<p>守护线程依赖于用户线程而存在，当用户线程全部结束后，可认为系统工作全部完成，整个系统会自然退出，即当一个java应用内只有守护线程时，java虚拟机会自动退出</p>
</blockquote>
<ul>
<li><p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonDemo</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonT</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">        sout(<span class="string">"i am alive"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    Thread t = <span class="keyword">new</span> DaemonT();</span><br><span class="line">    t.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    t.start();</span><br><span class="line">    </span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意：</p>
<blockquote>
<p>守护线程必须在调用start方法前，设置为Daemon：Thread.setDaemon(true)</p>
</blockquote>
</li>
</ul>
<h1 id="线程的优先级"><a href="#线程的优先级" class="headerlink" title="线程的优先级"></a>线程的优先级</h1><blockquote>
<p>有效范围为1～10</p>
<p>数值越大优先级越高</p>
<p>高优先级线程也可能会抢占资源失败，但一般有更大的概率抢占资源</p>
<p>低优先级线程可能可能一直抢占不到资源从而始终无法运行，而产生饥饿</p>
</blockquote>
<h1 id="线程安全与synchronized"><a href="#线程安全与synchronized" class="headerlink" title="线程安全与synchronized"></a>线程安全与synchronized</h1><ul>
<li><p>线程安全：</p>
<blockquote>
<p>在为了提高执行效率而进行程序的并行化的时候，前提是不能以牺牲程序的正确性为代价</p>
<p>要从根本上解决多个线程对相同数据进行写入操作时可能出现的冲突，必须保证此部分操作在执行时完全同步。</p>
<p>通过synchronized关键字可实现这部分功能</p>
</blockquote>
</li>
<li><p>synchronized关键字：</p>
<ul>
<li>指定加锁对象：对给定对象加锁，进入同步代码前需要获得指定对象的锁</li>
<li>直接作用于实例方法上：对当前实例加锁，进入同步代码前需要获得当前实例的锁</li>
<li>直接作用于静态方法：对当前类加锁，进入同步代码前要获得当前类的锁</li>
</ul>
</li>
<li><p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 锁对象方式实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountingSync</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> AccountingSync instance = <span class="keyword">new</span> AccountingSync();</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">1000000</span>;j++) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span>(instance) &#123;</span><br><span class="line">        i++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(instance);</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(instance);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    sout(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 锁实例方法实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountingSync2</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> AccountingSync2 instance = <span class="keyword">new</span> AccountingSync2();</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">100000</span>;j++) &#123;</span><br><span class="line">      increase();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(instance);</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(instance);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    sout(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







</li>
</ul>
<h1 id="第三章——JDK并发包-Page-70"><a href="#第三章——JDK并发包-Page-70" class="headerlink" title="第三章——JDK并发包(Page-70)"></a>第三章——JDK并发包(Page-70)</h1><h2 id="同步控制"><a href="#同步控制" class="headerlink" title="同步控制"></a>同步控制</h2><h3 id="重入锁——synchronized功能扩展"><a href="#重入锁——synchronized功能扩展" class="headerlink" title="重入锁——synchronized功能扩展"></a>重入锁——synchronized功能扩展</h3><p>java.util.concurrent.locks.ReentrantLock</p>
<ul>
<li><p>方法整理：</p>
<ul>
<li>lock ：获得锁，如果锁已经被占用，则等待</li>
<li>lockInterruptibly：获得锁，但优先响应中断</li>
<li>tryLock：尝试获得锁，如果成功返回true，失败返回false，不等待，立即返回<ul>
<li>锁空闲：直接获取锁并返回：true，设置锁的持有人数量为1</li>
<li>当前线程持有锁：直接获取锁并返回：true，同时锁持有人递增1</li>
<li>其他线程持有锁：获取锁失败，返回：false</li>
</ul>
</li>
<li>tryLock（long time，TimeUnit unit）：在给定时间内尝试获得锁</li>
<li>unlock</li>
</ul>
</li>
<li><p>重入锁三要素</p>
<blockquote>
<ol>
<li>原子状态：使用CAS操作来存储当前所得状态，判断锁是否被别的线程持有</li>
<li>等待队列：所有没有请求到锁的线程，会进入等待队列进行等待。待有线程释放锁后，系统就能从等待队列中唤醒一个线程继续工作</li>
<li>阻塞原语park（）和unpark（），用来挂起和恢复线程。没有得到锁的线程会被挂起。</li>
</ol>
</blockquote>
</li>
<li><p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReenterLock</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;<span class="number">1000000</span>; j++) &#123;</span><br><span class="line">      <span class="comment">// 使用重入锁保护临界区资源</span></span><br><span class="line">      lock.lock();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        i++;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 释放锁</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ReenterLock l1 = <span class="keyword">new</span> ReenterLock();</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(l1);</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(l1);</span><br><span class="line">    t1.start();</span><br><span class="line">    t1.start();</span><br><span class="line">    t1.join();</span><br><span class="line">    t1.join();</span><br><span class="line">    sout(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>一个线程中，重入锁可以反复进入，即一个线程可以多次获得同一把锁，但相应的需要释放对应数量的锁资源</p>
</li>
</ul>
<h4 id="中断响应"><a href="#中断响应" class="headerlink" title="中断响应"></a>中断响应</h4><ul>
<li><p>方法：lock.lockInterruptibly()</p>
</li>
<li><p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IntLock</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> ReetrantLock lock1 = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> ReetrantLock lock2 = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="keyword">int</span> lock;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  *控制加锁顺序，方便构造死锁</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">IntLock</span><span class="params">(<span class="keyword">int</span> lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lock = lock;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (lock == <span class="number">1</span>) &#123;</span><br><span class="line">        lock1.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;&#125;</span><br><span class="line">        lock2.lockInterruptibly();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lock2.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;&#125;</span><br><span class="line">        lock1.lockInterruptibly();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (lock1.isHeldByCurrentThread()) &#123;</span><br><span class="line">        lock1.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (lock2.isHeldByCurrentThread()) &#123;</span><br><span class="line">        lock2.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">      sout(Thread.currentThread().getId() + <span class="string">"线程退出"</span>)；</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    IntLock r1 = <span class="keyword">new</span> IntLock(<span class="number">1</span>);</span><br><span class="line">    IntLock r2 = <span class="keyword">new</span> IntLock(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// t1，t2分别持有1，2号锁并请求2，1号锁</span></span><br><span class="line">    <span class="comment">// 从而造成死锁</span></span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(r1);</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(r2);</span><br><span class="line">    t1.start();t2.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">// 中断其中一个线程（t2），从而另一个线程可获得所有锁资源完成任务并退出</span></span><br><span class="line">    <span class="comment">// 被中断线程放弃任务，直接退出</span></span><br><span class="line">    t2.interrupt();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="限时等待锁"><a href="#限时等待锁" class="headerlink" title="限时等待锁"></a>限时等待锁</h4><ul>
<li><p>方法：lock.tryLock(int time,TimeUnit.SECONDS</p>
</li>
<li><p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用传入时间参数的tryLock实例</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeLock</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (lock.tryLock(<span class="number">5</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sout(<span class="string">"get lock failed"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    TimeLock l1 = <span class="keyword">new</span> TimeLock();</span><br><span class="line">    <span class="comment">// t1,t2同时申请锁l1资源</span></span><br><span class="line">    <span class="comment">// t1持有l1 共6秒</span></span><br><span class="line">    <span class="comment">// t2等待l1 共5秒，t1仍未释放，t2自动退出等待</span></span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(l1);</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(l1);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用无参的tryLock实例</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TryLock</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> ReetrantLock lock1 = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> ReetrantLock lock2 = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="keyword">int</span> lock;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TryLock</span><span class="params">(<span class="keyword">int</span> lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lock = lock;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (lock == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lock1.tryLock()) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (lock2.tryLock()) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                sout(Thread.currentThread().getId() + <span class="string">"My Job done"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">              &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock2.unlock();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock1.unlock();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (lock2.tryLock()) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (lock1.tryLock()) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                sout(Thread.currentThread().getId() + <span class="string">"My Job done"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">              &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock1.unlock();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock2.unlcok();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// 同样，t1拿到lock1，请求lock2，t2拿到lock2，请求lock1，从而很容易触发死锁</span></span><br><span class="line">    <span class="comment">// 使用tryLock方法后，线程会不断重试获取锁</span></span><br><span class="line">    <span class="comment">// 同时，在线程的任务中，while循环每轮执行结束都会释放锁</span></span><br><span class="line">    <span class="comment">// 在足够长的时间后，线程总会得到所需的资源</span></span><br><span class="line">    TryLock r1 = <span class="keyword">new</span> TryLock(<span class="number">1</span>);</span><br><span class="line">    TryLock r2 = <span class="keyword">new</span> TryLock(<span class="number">2</span>);</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(r1);</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(r2);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="公平锁"><a href="#公平锁" class="headerlink" title="公平锁"></a>公平锁</h4><blockquote>
<p>公平锁会按照时间的先后顺序，保证先到者先得，后到者后得</p>
<p>不会产生饥饿现象</p>
</blockquote>
<ul>
<li><p>缺点：</p>
<blockquote>
<p>公平锁需要系统维护一个有序队列，实现成本较高，性能较低</p>
<p>通常情况下使用非公平锁</p>
</blockquote>
</li>
<li><p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FairLock</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 公平锁构造方法</span></span><br><span class="line">  <span class="comment">// 指定重入锁为公平锁</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> ReetrantLock fairLock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        failLock.lock();</span><br><span class="line">        sout(Thread.currentThread().getName() + <span class="string">"获得锁"</span>);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        failLock.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    FailLock r1 = <span class="keyword">new</span> FairLock();</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(r1, <span class="string">"Thread_t1"</span>);</span><br><span class="line">    Thread t2 = <span class="keyword">new</span> Thread(r1, <span class="string">"Thread_t2"</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="重入锁的好搭档——Condition条件"><a href="#重入锁的好搭档——Condition条件" class="headerlink" title="重入锁的好搭档——Condition条件"></a>重入锁的好搭档——Condition条件</h3><ul>
<li>基本方法<ul>
<li>void await：使当前线程等待 == wait方法</li>
<li>void awatiUninterruptibly：是当前线程等待，但等待过程中不会响应中断</li>
<li>long awaitNanos：</li>
<li>boolean await</li>
<li>boolean awaitUntil</li>
<li>void signal：唤醒一个等待中的线程</li>
<li>void signalAll：唤醒所有等待中的线程</li>
</ul>
</li>
</ul>
<p>###多个线程同时访问——信号量（Semaphore）</p>
<ul>
<li>构造方法<ul>
<li>public Semaphore(int permits)：指定准入线程数</li>
<li>public Semaphore(int permits, boolean fair)：准入线程数，公平锁</li>
</ul>
</li>
<li>逻辑方法<ul>
<li>public void acquire()</li>
<li>public void acquireUninterruptibly()</li>
<li>public boolean tryAcquire()</li>
<li>public boolean tryAcquire(long timeout, TimeUnit unit)</li>
<li>public void  release()</li>
</ul>
</li>
</ul>
<h3 id="ReadWriteLock-读写锁"><a href="#ReadWriteLock-读写锁" class="headerlink" title="ReadWriteLock 读写锁"></a>ReadWriteLock 读写锁</h3><ul>
<li><p>阻塞情况</p>
<table>
<thead>
<tr>
<th></th>
<th>读</th>
<th>写</th>
</tr>
</thead>
<tbody><tr>
<td>读</td>
<td>非阻塞</td>
<td>阻塞</td>
</tr>
<tr>
<td>写</td>
<td>阻塞</td>
<td>阻塞</td>
</tr>
</tbody></table>
</li>
<li><p>示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadWriteLockDemo</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> ReentrantReadWriteLock readWriteLock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Lock readLock = readWriteLock.readLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Lock readLock = readWriteLock.writeLock();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">handleRead</span><span class="params">(Lock lock)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      lock.lock(); <span class="comment">// 读操作</span></span><br><span class="line">      Thread.sleep(<span class="number">1000</span>); <span class="comment">// 提高读操作的耗时</span></span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleWrite</span> <span class="params">(Lock lock, <span class="keyword">int</span> index)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      lock.lock(); <span class="comment">// 模拟写操作</span></span><br><span class="line">      Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">      value = index;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReadWriteLockDemo demo = <span class="keyword">new</span> ReadWriteLockDemo();</span><br><span class="line">    Runnable readRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          demo.handleRead(readLock);</span><br><span class="line">          <span class="comment">// demo.handleRead(lock);</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    Runnable writeRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          demo.handleWrite(writeLock, <span class="keyword">new</span> Random().nextInt());</span><br><span class="line">          <span class="comment">// demo.handleWrite(lock, new Random().nextInt());</span></span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">18</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">new</span> Thread(readRunnable).start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">18</span>; i&lt;<span class="number">20</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">new</span> Thread(writeRunnable).start();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="倒计时器：CountDownLatch"><a href="#倒计时器：CountDownLatch" class="headerlink" title="倒计时器：CountDownLatch"></a>倒计时器：CountDownLatch</h3><ul>
<li><p>功能：控制线程等待，让某一个线程等待直到倒计时结束，再开始执行</p>
</li>
<li><p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchDemo</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch end = <span class="keyword">new</span> CountDownLatch(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatchDemo demo = <span class="keyword">new</span> CountDownLatchDemo();</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 模拟检查任务</span></span><br><span class="line">      Thread.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">10</span>)*<span class="number">1000</span>);</span><br><span class="line">      sout(<span class="string">"check complete"</span>);</span><br><span class="line">      <span class="comment">// 线程计数数量减一</span></span><br><span class="line">      end.countDown();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ExecutorService exec = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">      exec.submit(demo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 等待检查</span></span><br><span class="line">    end.await();</span><br><span class="line">    <span class="comment">// 发射火箭</span></span><br><span class="line">    sout(<span class="string">"Fire!"</span>);</span><br><span class="line">    exec.shutdown();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="循环栅栏：CyclicBarrier"><a href="#循环栅栏：CyclicBarrier" class="headerlink" title="循环栅栏：CyclicBarrier"></a>循环栅栏：CyclicBarrier</h3><ul>
<li>也可用于实现计数器</li>
<li>功能更强，是一个可以循环使用的计数器</li>
<li>构造方法：CyclicBarrier(int parties, Runnable barrierAction)</li>
</ul>
<h3 id="线程阻塞工具类：LockSupport"><a href="#线程阻塞工具类：LockSupport" class="headerlink" title="线程阻塞工具类：LockSupport"></a>线程阻塞工具类：LockSupport</h3><ul>
<li><p>方法：</p>
<ul>
<li>park</li>
<li>unpark</li>
</ul>
</li>
<li><p>机制：</p>
<blockquote>
<p>采用类似信号量的机制，为每一个线程准备了一个许可，如果许可可用，则park方法立刻返回，并将此许可修改为不可用。</p>
<p>如果许可不可用，就会阻塞</p>
<p>unpark方法可使一个许可变为可用</p>
</blockquote>
</li>
</ul>
<h1 id="线程复用——线程池"><a href="#线程复用——线程池" class="headerlink" title="线程复用——线程池"></a>线程复用——线程池</h1><ul>
<li><p>概念</p>
<blockquote>
<p>为了节约频繁创建和销毁线程所使用的时间，系统通过维持一个线程池，实现对线程的复用。</p>
<p>当客户程序需要使用线程时，可以从池子中获取一个空闲线程。</p>
<p>当线程完成工作后，可以将此活跃线程退回到线程池中，供其他客户程序复用而非直接关闭线程</p>
</blockquote>
</li>
<li><p>线程池框架——Executor（JDK提供）</p>
<ul>
<li><p>获取线程池方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取一个固定数量的线程池</span></span><br><span class="line">newFixedThreadPool();</span><br><span class="line"><span class="comment">// 返回一个只有一个线程的线程池</span></span><br><span class="line">newSingleThreadExecutor();</span><br><span class="line"><span class="comment">// 返回一个可以根据实际情况调整线程数量的线程池</span></span><br><span class="line">newCachedThreadPool();</span><br><span class="line"><span class="comment">// 返回一个ScheduledExecutorService对象，线程池大小为1.</span></span><br><span class="line"><span class="comment">// 扩展了在指定时间执行某任务的功能</span></span><br><span class="line">newSingleThreadScheduledExecutor();</span><br><span class="line"><span class="comment">// 返回一个可指定线程数量的ScheduledExecutorService</span></span><br><span class="line">newScheduledThreadPool();</span><br><span class="line"><span class="comment">// 周期调度器，如果某个任务本身抛出了异常，则后续任务都会停止</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>当新任务到来，线程池内无空闲线程时，线程池可将新任务存储于任务队列中，当有线程（完成任务，空闲）退回线程池时，从任务队列中获取任务</p>
</li>
</ul>
</li>
<li><p>线程池的内部实现</p>
<blockquote>
<p>对于核心的几个线程池，其内部实现均使用了ThreadPoolExecutor</p>
</blockquote>
<ul>
<li><p>ThreadPoolExecutor构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize, <span class="keyword">int</span> maximumPoolSize, <span class="keyword">long</span> keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler)</span></span>;</span><br><span class="line"><span class="comment">// 参数意义</span></span><br><span class="line">corePoolSize:指定了线程池中的线程数量</span><br><span class="line">maximumPoolSize：线程池最大线程数量</span><br><span class="line">keepAliveTime：线程池线程超过corePoolSize时，多余空闲线程的存活时间</span><br><span class="line">unit：keepAliveTime的单位</span><br><span class="line">workQueue：任务队列</span><br><span class="line">threadFactory：线程工厂，创建线程（一般用默认的即可）</span><br><span class="line">handler：拒绝策略（任务过多时，如何拒绝任务）</span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ul>
<ul>
<li><p>值得详细说明的参数</p>
<ul>
<li><p>workQueue任务队列</p>
<ul>
<li><p>直接提交队列</p>
<blockquote>
<p>由SynchronousQueue（是一个特殊的BlockingQueue）对象提供。</p>
<p>SynchronousQueue没有容量，插入等相应删除，删除等对应插入</p>
<p>新任务不会被真实保存而是直接提交给线程执行，如果无空闲线程则尝试创建新线程，如果线程线程数量到达最大值则执行拒绝策略</p>
<p>使用SynchronousQueue时，maximumPoolSize应该设置很大</p>
</blockquote>
</li>
<li><p>有界的任务队列</p>
<blockquote>
<p>可使用ArrayBlockingQueue实现</p>
<p>构造函数必须带有一个容量参数，表示队列最大容量</p>
<p>新任务进入，如果线程池实际线程数小于corePoolSize，则优先创建新的线程</p>
</blockquote>
</li>
<li><p>无界的任务队列</p>
<blockquote>
<p>可使用LinkedBlockingQueue实现</p>
<p>除非系统资源耗尽，不然不会出现任务入队失败的情况</p>
<p>当有新任务到来，系统线程数少于corePoolSize时，线程池会生成新的线程执行任务，但线程数达到corePoolSize后，任务直接进入队列等待，不增加新线程。</p>
<p>当任务创建和处理的速度差异很大时，无界队列会保持快速增长直到耗尽系统资源</p>
</blockquote>
</li>
<li><p>优先任务队列</p>
<blockquote>
<p>通过PriorityBlockingQueue实现，可控制任务执行的先后顺序</p>
<p>特殊的无界队列</p>
<p>（个人猜测，使用堆排序实现）</p>
<p>根据任务优先级执行，确保系统性能的同时，有很好的质量保证</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="线程池调度"><a href="#线程池调度" class="headerlink" title="线程池调度"></a>线程池调度</h1><ul>
<li><p>核心代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ThreadPoolExecutor 核心调度代码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (command == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">  <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">    <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    c = ctl.get();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">    <span class="keyword">int</span> recheck = ctl.get();</span><br><span class="line">    <span class="keyword">if</span> (!isRunning(recheck) &amp;&amp; remove(command)) &#123;</span><br><span class="line">      reject(command);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>) &#123;</span><br><span class="line">      addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>)) &#123;</span><br><span class="line">    reject(command);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调度逻辑</p>
<ol>
<li>任务提交</li>
<li>工作线程数与corePoolSize比较<ul>
<li>小于：分配线程执行</li>
<li>大于：提交等待队列：<ul>
<li>成功：等待执行任务</li>
<li>失败（队列满或同步锁）：直接提交到线程池<ul>
<li>线程池达到maxSize：提交失败，拒绝执行</li>
<li>线程池未达到maxSize：提交成功，分配新线程执行</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<h1 id="拒绝策略"><a href="#拒绝策略" class="headerlink" title="拒绝策略"></a>拒绝策略</h1><ul>
<li><p>AbortPolicy策略：</p>
<blockquote>
<p>直接抛出异常，阻止系统正常工作</p>
</blockquote>
</li>
<li><p>CallerRunsPolicy策略：</p>
<blockquote>
<p>只要线程池未关闭，该策略直接在当前调用者线程中，运行被丢弃的任务</p>
<p>不会真正丢掉任务，但是任务提交线程性能极有可能会急剧下降</p>
</blockquote>
</li>
<li><p>DiscardOledestPolicy策略：</p>
<blockquote>
<p>丢弃最老的任务（即将被执行的任务）并尝试再次提交当前任务</p>
</blockquote>
</li>
<li><p>DiscardPolicy策略：</p>
<blockquote>
<p>该策略默默丢弃无法处理的请求，不进行任何处理（允许任务丢失的情况下最好方案）</p>
</blockquote>
</li>
</ul>
<h2 id="自定义线程池（扩展拒绝策略）"><a href="#自定义线程池（扩展拒绝策略）" class="headerlink" title="自定义线程池（扩展拒绝策略）"></a>自定义线程池（扩展拒绝策略）</h2><ul>
<li><p>示例代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RejectThreadPoolDemo</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(System.currentTimeMilles() + <span class="string">":Thread ID:"</span> + Thread.currentThread().getId());</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    MyTask task = <span class="keyword">new</span> MyTask();</span><br><span class="line">    ExecutorService es = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">5</span>,<span class="number">5</span>,OL,</span><br><span class="line">                                                TimeUnit.MILLISECONDS,</span><br><span class="line">                                                <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">10</span>),</span><br><span class="line">                                                Executors.defaultThreadFactory(),</span><br><span class="line">                                                <span class="keyword">new</span> RejectedExecutionHandler() &#123;</span><br><span class="line">                                                  <span class="meta">@Override</span></span><br><span class="line">                                                  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                               ThreadPoolExecutor executor)</span> </span>&#123;</span><br><span class="line">                                                    sout(r.toStirng() + <span class="string">"is discard"</span>);</span><br><span class="line">                                                  &#125;</span><br><span class="line">                                                &#125;);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;Integer.MAX_VALUE; i++) &#123;</span><br><span class="line">      es.submit(task);</span><br><span class="line">      Thread.sleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="合理选择线程池线程数量"><a href="#合理选择线程池线程数量" class="headerlink" title="合理选择线程池线程数量"></a>合理选择线程池线程数量</h2><ul>
<li><p>经验公式</p>
<blockquote>
<p>Ncpu = CPU数量</p>
<p>Ucpu = 目标cpu使用率，0 &lt;= Ucpu &lt;= 1</p>
<p>W/C = 等待时间与计算时间的比率</p>
</blockquote>
</li>
<li><p>最优池大小：</p>
<blockquote>
<p>Nthreads = Ncpu * Ucpu * (1 + W/C)</p>
<p>java中可通过Runtime.getRuntime().availableProcessors()取得可用的CPU数量</p>
</blockquote>
</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/11/http基础/" rel="next" title="http基础">
                <i class="fa fa-chevron-left"></i> http基础
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/25/SpringBoot文档翻译/" rel="prev" title>
                 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">freshham</p>
              <p class="site-description motion-element" itemprop="description">this is freshham's blog estimated by hexo</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#指令重排"><span class="nav-number">1.</span> <span class="nav-text">指令重排</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-定义"><span class="nav-number">1.1.</span> <span class="nav-text">1. 定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-数据依赖性（仅单线程下有效）"><span class="nav-number">1.2.</span> <span class="nav-text">2. 数据依赖性（仅单线程下有效）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-as-if-serial语义"><span class="nav-number">1.3.</span> <span class="nav-text">3. as-if-serial语义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Happen-Before规则"><span class="nav-number">1.4.</span> <span class="nav-text">4. Happen-Before规则</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#进程与线程"><span class="nav-number">2.</span> <span class="nav-text">进程与线程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义"><span class="nav-number">2.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#线程的状态"><span class="nav-number">2.2.</span> <span class="nav-text">线程的状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#线程的基本操作"><span class="nav-number">2.3.</span> <span class="nav-text">线程的基本操作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#等待（wait）和通知（notify）"><span class="nav-number">3.</span> <span class="nav-text">等待（wait）和通知（notify）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#挂起（suspend）和继续执行（resume）线程"><span class="nav-number">4.</span> <span class="nav-text">挂起（suspend）和继续执行（resume）线程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#等待线程结束（join）与谦让（yield）"><span class="nav-number">5.</span> <span class="nav-text">等待线程结束（join）与谦让（yield）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#volatile与java内存模型（JMM）"><span class="nav-number">6.</span> <span class="nav-text">volatile与java内存模型（JMM）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#线程组：分门别类的管理"><span class="nav-number">7.</span> <span class="nav-text">线程组：分门别类的管理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#守护线程（Daemon）"><span class="nav-number">8.</span> <span class="nav-text">守护线程（Daemon）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#线程的优先级"><span class="nav-number">9.</span> <span class="nav-text">线程的优先级</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#线程安全与synchronized"><span class="nav-number">10.</span> <span class="nav-text">线程安全与synchronized</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第三章——JDK并发包-Page-70"><span class="nav-number">11.</span> <span class="nav-text">第三章——JDK并发包(Page-70)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#同步控制"><span class="nav-number">11.1.</span> <span class="nav-text">同步控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#重入锁——synchronized功能扩展"><span class="nav-number">11.1.1.</span> <span class="nav-text">重入锁——synchronized功能扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#中断响应"><span class="nav-number">11.1.1.1.</span> <span class="nav-text">中断响应</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#限时等待锁"><span class="nav-number">11.1.1.2.</span> <span class="nav-text">限时等待锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#公平锁"><span class="nav-number">11.1.1.3.</span> <span class="nav-text">公平锁</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重入锁的好搭档——Condition条件"><span class="nav-number">11.1.2.</span> <span class="nav-text">重入锁的好搭档——Condition条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ReadWriteLock-读写锁"><span class="nav-number">11.1.3.</span> <span class="nav-text">ReadWriteLock 读写锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#倒计时器：CountDownLatch"><span class="nav-number">11.1.4.</span> <span class="nav-text">倒计时器：CountDownLatch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#循环栅栏：CyclicBarrier"><span class="nav-number">11.1.5.</span> <span class="nav-text">循环栅栏：CyclicBarrier</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程阻塞工具类：LockSupport"><span class="nav-number">11.1.6.</span> <span class="nav-text">线程阻塞工具类：LockSupport</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#线程复用——线程池"><span class="nav-number">12.</span> <span class="nav-text">线程复用——线程池</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#线程池调度"><span class="nav-number">13.</span> <span class="nav-text">线程池调度</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#拒绝策略"><span class="nav-number">14.</span> <span class="nav-text">拒绝策略</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义线程池（扩展拒绝策略）"><span class="nav-number">14.1.</span> <span class="nav-text">自定义线程池（扩展拒绝策略）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#合理选择线程池线程数量"><span class="nav-number">14.2.</span> <span class="nav-text">合理选择线程池线程数量</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">freshham</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
